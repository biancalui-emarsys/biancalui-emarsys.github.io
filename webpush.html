<html>
<head>
  <title>Push Demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="/manifest.json">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="/src/web-emarsys-sdk.js" async></script>
  <script type="text/javascript">
    const version = 'Version: 20231024 1525'

    const urlParams = new URLSearchParams(window.location.search)
    const appCode = urlParams.get('app_code')
    const vapid = urlParams.get('vapid') === '1'
    console.log(vapid)
    if (appCode != null) {
      var WebEmarsysSdk = WebEmarsysSdk || []
      WebEmarsysSdk.push(['init', {
        enableLogging: true,
        applicationCode: appCode,
        enableSafariVapid: vapid,
        safariWebsitePushID: 'web.com.dbappfactory.emarsys.demo',
        defaultNotificationTitle: 'WebEmarsysSdk Demo',
        defaultNotificationIcon: 'https://demo.emarsys.net/custloads/213679138/md_100037165.jpg',
        serviceWorker: {
          url: 'service-worker.js',
          applicationServerPublicKey: 'BDa49_IiPdIo2Kda5cATItp81sOaYg-eFFISMdlSXatDAIZCdtAxUuMVzXo4M2MXXI0sUYQzQI7shyNkKgwyD_I'
        }
      }])
    }

    function subscribe() {
      WebEmarsysSdk.push(function (api) {
        console.log('now subscribe', api);
        WebEmarsysSdk.subscribe()
      })
    }

    function unsubscribe() {
      WebEmarsysSdk.push(function (api) {
        console.log('now unsubscribe', api);
        WebEmarsysSdk.unsubscribe()
      })
    }

    function login() {
      console.log('now login')
      const contactInfo = {
        fieldId: Number(document.getElementById('fieldId').value),
        fieldValue: document.getElementById('fieldValue').value
      }
      WebEmarsysSdk.login(contactInfo)
        .then(function (success) {
          console.log('login ', success)
        })
        .catch(function (err) {
          console.error(err)
        })
        .then(function () {

        })
    }

    function logout() {
      console.log('now logout')
      WebEmarsysSdk.logout()
        .then(function (success) {
          console.log('logout ', success)
        })
        .catch(function (err) {
          console.error(err)
        })
        .then(function () {

        })
    }

    function getLoggedInContact() {
      console.log('now getLoggedInContact')
      WebEmarsysSdk.getLoggedInContact()
        .then(function (res) {
          console.log(res)
          console.log(`${res.fieldValue} (field ID: ${res.fieldId})`)
        }).catch(function (err) {
          console.error(err)
        })
    }

    function trackCustomEvent() {
      console.log('now customEvent')
      WebEmarsysSdk.customEvent('testEvent', { k1: 'v1', k2: 'v2' })
        .then((success) => {
          console.log('customEvent ', success)
        }).catch(err => {
          console.error(err)
        })
    }

  </script>
</head>

<body>
  <p id="version"></p>
  <div>
    <form action="">
      <label for="appCode">App code:</label>
      <input type="text" id="appCode" name="app_code">
      <input type="submit" value="Change">
    </form>
  </div>
  <div id="appCodeDiv">
    <button type="button" onclick="subscribe()">subscribe</button><br />
    <button type="button" onclick="unsubscribe()">unsubscribe</button><br />
    <br />
    <label for="fieldId">Contact field id:</label>
    <input type="text" id="fieldId" value="100010824"><br />
    <label for="fieldValue">Contact field value:</label>
    <input type="text" id="fieldValue" value="biancalui"><br />
    <button type="button" onclick="login()">login</button><br />
    <button type="button" onclick="logout()">logout</button><br />
    <br />
    <button type="button" onclick="getLoggedInContact()">getLoggedInContact</button><br />
    <button type="button" onclick="trackCustomEvent()">trackCustomEvent</button><br />
    <br />
    <div id="resultDiv"></div>
  </div>
</body>

<script type="text/javascript">
  $('#version').text(version)
  if (appCode != null) {
    document.getElementById('appCode').value = appCode;
  } else {
    document.getElementById('appCodeDiv').style.display = 'none';
  }

  WebEmarsysSdk.push(function (api) {
    console.log('onReady');
    console.log('now isSubscribed');
    WebEmarsysSdk.isSubscribed()
      .then(function (res) {
        console.log('isSubscribed ', res)
      }).catch(function (err) {
        console.error(err)
      })
  })

  WebEmarsysSdk.push(['onSubscribe', function (api) {
    console.log('onSubscribe');
  }]);
  WebEmarsysSdk.push(['onUnsubscribe', function (api) {
    console.log('onUnsubscribe');
  }]);

  WebEmarsysSdk.push(['onPermissionPrompt', function (res) {
    console.log('onPermissionPrompt');
    WebEmarsysSdk.push(['onPermissionGranted', function (res) {
      console.log('onPermissionPrompt onPermissionGranted');
    }]);
  }]);
  WebEmarsysSdk.push(['onPermissionGranted', function (res) {
    console.log('onPermissionGranted');
  }]);

  WebEmarsysSdk.push(function (res) {
    WebEmarsysSdk.push(['onPermissionGranted', function (res) {
      console.log('onReady onPermissionGranted');
    }]);
  });
  WebEmarsysSdk.push(['onReady', function (res) {
    WebEmarsysSdk.push(['onPermissionGranted', function (res) {
      console.log('"onReady" onPermissionGranted');
      // WebEmarsysSdk.subscribe();
    }]);
  }]);

</script>
</html>