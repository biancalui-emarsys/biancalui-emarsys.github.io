{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/lib/logging.ts","webpack:///./src/lib/constants.ts","webpack:///./src/lib/utils.ts","webpack:///./src/lib/storage-with-log.ts","webpack:///./src/lib/jwt.ts","webpack:///./src/lib/me-device-event-service.ts","webpack:///./src/lib/me-client-service.ts","webpack:///./src/lib/me-v3-api-request.ts","webpack:///./src/lib/me-web-push-db.ts","webpack:///./src/lib/index-db.ts","webpack:///./src/web-emarsys-service-worker.ts","webpack:///./src/lib/emarsys-service-worker.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","SdkContext","NoopLogFn","loggingFunction","context","level","data","console","Logger","trace","debug","info","warn","error","log","exportedParts","enableLogger","enabled","methods","method","SwContext","defaultClientServiceApiBaseUrl","defaultDeviceEventServiceApiBaseUrl","defaultSafariPushPackageServiceUrl","defaultApplicationVersion","loginOverloadProtectionTime","pushTitleProperty","pushLinkProperty","pushIconProperty","pushImageProperty","pushActionsProperty","applicationPassword","dbKeyDefaultNotificationTitle","dbKeyDefaultNotificationIcon","dbKeyApplicationCode","dbKeyMeClientServiceApiBaseUrl","dbKeyMeDeviceEventServiceApiBaseUrl","dbKeyServiceWorkerUrl","dbKeyServiceWorkerScope","dbKeyApplicationServerPublicKey","dbKeyWebsitePushId","dbKeyPushPackageServiceUrl","dbKeyLastPermissionStatus","dbKeyInitParams","dbKeyBrowserId","dbKeyBrowserIds","dbKeyXClientState","dbKeyContactToken","dbKeyRefreshToken","dbKeySdkVersion","dbKeyServiceWorkerVersion","dbKeyPushToken","dbKeyContactFieldId","dbKeyContactFieldValue","dbKeyPlatform","dbKeyApplicationVersion","dbKeyDeviceModel","dbKeyOsVersion","dbKeyLanguage","dbKeyTimezone","dbKeyLoggingEnabled","dbKeyLastUsedAt","lsKeyLastLoginTime","lsKeyLastLoginToken","lsKeyLastContactFieldId","meLogin","meLogout","meOpen","meCustomEvent","indexedDbName","indexedDbVersion","PERMISSION_DENIED","PERMISSION_GRANTED","PERMISSION_PROMPT","EVENT_ON_READY","EVENT_ON_SUBSCRIBE","EVENT_ON_UNSUBSCRIBE","EVENT_ON_PERMISSION_PROMPT","EVENT_ON_PERMISSION_DENIED","EVENT_ON_PERMISSION_GRANTED","EVENT_ON_SW_INIT_ERROR","EVENT_ON_PUSH_DELIVERY","EVENT_ON_PUT_NEW_MESSAGE_TO_INBOX_STORE","EVENT_ON_UPDATE_INBOX_MESSAGES","EVENT_ON_SHOW_NOTIFICATION_PERMISSION_DIALOG","EVENT_ON_HIDE_NOTIFICATION_PERMISSION_DIALOG","KEY_DEVICE_REGISTRATION_STATUS","DEVICE_REGISTRATION_STATUS_REGISTERED","DEVICE_REGISTRATION_STATUS_UNREGISTERED","base64ToBinary","base64String","base64","repeat","length","replace","atob","async","checkDevice","meWebPushDb","getClientId","exists","clientState","getClientState","decodedClientState","JWT","decode","pushTokenExists","pushToken","identified","contactField","Function","rawData","outputArray","Uint8Array","charCodeAt","undefined","payloadMessageDataProperties","id","sid","applicationCode","notificationSettings","payload","emarsysPayload","messageData","keys","map","prop","reduce","acc","contactInfo","isEmptyObject","obj","params","scope","constructor","storage","this","defaultMessage","message","clientId","contactToken","getContactToken","refreshToken","getRefreshToken","token","options","pos","header","JSON","parse","urlB64ToString","split","err","PostEventsOKStates","MEDeviceEventService","baseUrl","desRequest","storageWithLog","StorageWithLog","eventsData","success","apiEndpoint","response","post","includes","status","statusCode","body","json","stringify","path","appCode","getAppCode","static","MEClientService","meClientServiceRequest","clientDetails","getClientDetails","saveClientState","anonymous","toContactRequestBodyData","responseBody","Promise","all","setContactToken","setRefreshToken","put","delete","headers","setClientState","platform","getPlatform","applicationVersion","getApplicationVersion","deviceModel","getDeviceModel","osVersion","getOsVersion","sdkVersion","getSdkVersion","language","getLanguage","timezone","getTimezone","Error","contactFieldId","fieldId","openIdToken","contactFieldValue","fieldValue","contactFieldEncrypted","encrypted","defaultHeaders","MEV3ApiRequest","requestOrder","endpoint","headerData","requestInit","createPostRequestInit","fetch","createPutRequestInit","createDeleteRequestInit","createRequestInit","buildHeaders","cache","Headers","forEach","k","append","MEWebPushDb","indexDb","defaultTitle","getDBValueOrDefault","CONSTANTS","defaultImage","getBrowserIdsFromDb","toUpperCase","browserIdsString","browserIds","addLegacyBrowserId","legacyBrowserId","setDBValue","getDBValue","getClientIdForAppCode","then","v","Number","flag","toLowerCase","url","toString","version","clientIds","icon","Date","toISOString","deleteDBKey","setAppCode","setDefaultNotificationIcon","setDefaultNotificationTitle","setServiceWorkerUrl","setServiceWorkerScope","setApplicationServerPublicKey","setSdkVersion","setServiceWorkerVersion","setInitParams","setWebsitePushId","setPushPackageServiceUrl","setLastPermissionStatus","setPushToken","setContactFieldId","setContactFieldValue","setPlatform","setApplicationVersion","setDeviceModel","setTimezone","setLanguage","setOsVersion","setMeClientServiceApiBaseUrl","setMeDeviceEventServiceApiBaseUrl","deleteLastUsedAt","NotFoundMessage","IndexDb","openIndexDB","database","resolve","reject","request","transaction","objectStore","onsuccess","indexedDBInstance","close","onerror","e","result","event","defaultVal","indexedDB","open","target","onupgradeneeded","createObjectStore","keyPath","webPushDb","worker","EmarsysServiceWorker","self","addEventListener","onPush","onNotificationClick","onInstall","onSubscriptionChange","FailureResult","waitUntil","handleInstall","_onPush","_onNotificationClick","_onSubscriptionChange","setupLogging","registration","payloadJson","isValidPayload","getNotificationOption","getDefaultNotificationTitle","getDefaultNotificationIcon","notificationTitle","notificationIcon","notificationImage","notificationActions","showNotification","createActionsFromActionButtons","action","notification","buttonClicked","find","actionButton","commands","push","clients","openWindow","reportOpen","applicationServerKey","getApplicationServerKey","subscription","pushManager","subscribe","userVisibleOnly","registerNewSubscription","isRetry","meClientSvc","getMeClientService","registerPushToken","refreshContactToken","getApplicationServerPublicKey","notificationOptions","image","actions","vibrate","notificationData","notificationDataPropertyName","dbFallbackFn","skipWaiting","loggingEnabled","getLoggingEnabled","des","getDeviceEventService","treatments","attributes","dnd","events","type","timestamp","clicks","viewedMessages","postEvents","retrySendAfterContactTokenRefresh","generateAccessToken","meDeviceEventService","getMeDeviceEventServiceApiBaseUrl","meClientService","getMeClientServiceApiBaseUrl","actionButtons","title"],"mappings":"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","file":"web-emarsys-service-worker.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 12);\n","export type LogFn = (...args: any) => void\n\nconst SdkContext = '[WebEmarsysSDK]'\nconst SwContext = '[WebEmarsysSW]'\n\ninterface IConsoleLogging {\n  trace: LogFn\n  debug: LogFn\n  info: LogFn\n  warn: LogFn\n  error: LogFn\n  log: LogFn\n  [key: string]: LogFn // just for being able to loop over the entries\n}\n\n// tslint:disable-next-line:no-empty\nconst NoopLogFn: LogFn = () => {}\n\nconst loggingFunction = (context: string, level: string) => {\n  return (...data: any[]) => {\n    (console as any)[level](context, ...data)\n  }\n}\n\n/**\n * Enables the Logger by setting all log function references to the respective\n * functions of the global console.\n */\nfunction enableLogger (enabled: boolean, context: string = SdkContext) {\n  const methods = ['trace', 'debug', 'info', 'warn', 'error', 'log']\n  if (enabled) {\n    for (const method of methods) {\n      Logger[method] = loggingFunction(context, method)\n    }\n  } else {\n    for (const method of methods) {\n      Logger[method] = NoopLogFn\n    }\n  }\n}\n\n/**\n * The logger which provides logging functions. By default the functions\n * are disabled which means they point to the NoopLogFn.\n */\nconst Logger: IConsoleLogging = {\n  trace: NoopLogFn,\n  debug: NoopLogFn,\n  info: NoopLogFn,\n  warn: NoopLogFn,\n  error: NoopLogFn,\n  log: NoopLogFn\n}\n\nconst exportedParts = {\n  NoopLogFn,\n  enableLogger,\n  SdkContext,\n  SwContext,\n  Logger\n}\n\nexport default exportedParts\n","export const defaultClientServiceApiBaseUrl = 'https://me-client.eservice.emarsys.net/v3'\nexport const defaultDeviceEventServiceApiBaseUrl = 'https://mobile-events.eservice.emarsys.net/v3'\nexport const defaultSafariPushPackageServiceUrl = 'https://me-client.eservice.emarsys.net'\n\nexport const defaultApplicationVersion = '0.0.0'\n\nexport const loginOverloadProtectionTime = 3600000\n\nexport const pushTitleProperty = 'title'\n\n// property names in push notification data\nexport const pushLinkProperty = 'link'\nexport const pushIconProperty = 'icon'\nexport const pushImageProperty = 'image'\nexport const pushActionsProperty = 'actions'\n\n// ingester requests password\nexport const applicationPassword = 'not-used'\n\n// indexDb keys\nexport const dbKeyDefaultNotificationTitle = 'pushDefaultNotificationTitle'\nexport const dbKeyDefaultNotificationIcon = 'pushDefaultNotificationIcon'\nexport const dbKeyApplicationCode = 'emarsysApplicationCode'\nexport const dbKeyMeClientServiceApiBaseUrl = 'meClientServiceApiBaseUrl'\nexport const dbKeyMeDeviceEventServiceApiBaseUrl = 'meDeviceEventServiceApiBaseUrl'\nexport const dbKeyServiceWorkerUrl = 'serviceWorkerUrl'\nexport const dbKeyServiceWorkerScope = 'serviceWorkerScope'\nexport const dbKeyApplicationServerPublicKey = 'applicationServerPublicKey'\nexport const dbKeyWebsitePushId = 'websitePushId'\nexport const dbKeyPushPackageServiceUrl = 'pushPackageServiceUrl'\nexport const dbKeyLastPermissionStatus = 'lastPermissionStatus'\nexport const dbKeyInitParams = 'initParams'\nexport const dbKeyBrowserId = 'browserId'\nexport const dbKeyBrowserIds = 'browserIds'\nexport const dbKeyXClientState = 'xClientState'\nexport const dbKeyContactToken = 'contactToken'\nexport const dbKeyRefreshToken = 'refreshToken'\nexport const dbKeySdkVersion = 'sdkVersion'\nexport const dbKeyServiceWorkerVersion = 'serviceWorkerVersion'\nexport const dbKeyPushToken = 'pushToken'\nexport const dbKeyContactFieldId = 'contactFieldId'\nexport const dbKeyContactFieldValue = 'contactFieldValue'\nexport const dbKeyPlatform = 'platform'\nexport const dbKeyApplicationVersion = 'applicationVersion'\nexport const dbKeyDeviceModel = 'deviceModel'\nexport const dbKeyOsVersion = 'osVersion'\nexport const dbKeyLanguage = 'language'\nexport const dbKeyTimezone = 'timezone'\nexport const dbKeyLoggingEnabled = 'loggingEnabled'\nexport const dbKeyLastUsedAt = 'lastUsedAt'\n\n// localStorage keys\nexport const lsKeyLastLoginTime = 'emarsysWebpushLastLoginTime'\nexport const lsKeyLastLoginToken = 'emarsysWebpushLastLoginToken'\nexport const lsKeyLastContactFieldId = 'emarsysWebpushLastContactFieldId'\n\n// ME endpoints\nexport const meLogin = '/users/login'\nexport const meLogout = '/users/logout'\nexport const meOpen = '/events/message_open'\nexport const meCustomEvent = '/events/'\n\n// Indexed DB\nexport const indexedDbName = 'EMARSYS_WEBPUSH_STORE'\nexport const indexedDbVersion = 1\n\n// Permissions\nexport const PERMISSION_DENIED = 'denied'\nexport const PERMISSION_GRANTED = 'granted'\nexport const PERMISSION_PROMPT = 'default'\n\n// Events\nexport const EVENT_ON_READY = 'onReady'\nexport const EVENT_ON_SUBSCRIBE = 'onSubscribe'\nexport const EVENT_ON_UNSUBSCRIBE = 'onUnsubscribe'\nexport const EVENT_ON_PERMISSION_PROMPT = 'onPermissionPrompt'\nexport const EVENT_ON_PERMISSION_DENIED = 'onPermissionDenied'\nexport const EVENT_ON_PERMISSION_GRANTED = 'onPermissionGranted'\nexport const EVENT_ON_SW_INIT_ERROR = 'onSWInitError'\nexport const EVENT_ON_PUSH_DELIVERY = 'onPushDelivery'\nexport const EVENT_ON_PUT_NEW_MESSAGE_TO_INBOX_STORE = 'onPutNewMessageToInboxStore'\nexport const EVENT_ON_UPDATE_INBOX_MESSAGES = 'onUpdateInboxMessages'\nexport const EVENT_ON_SHOW_NOTIFICATION_PERMISSION_DIALOG = 'onShowNotificationPermissionDialog'\nexport const EVENT_ON_HIDE_NOTIFICATION_PERMISSION_DIALOG = 'onHideNotificationPermissionDialog'\n\n// LocalStore\nexport const KEY_DEVICE_REGISTRATION_STATUS = 'registrationStatus'\n\n// Device registration status\nexport const DEVICE_REGISTRATION_STATUS_REGISTERED: string = 'registered'\nexport const DEVICE_REGISTRATION_STATUS_UNREGISTERED: string = 'unregistered'\n","import { MEWebPushDb } from './me-web-push-db'\nimport * as JWT from './jwt'\n\nexport type DeviceCheckResult = {\n  exists: boolean\n  pushTokenExists?: boolean\n  identified?: boolean\n}\n\nexport function getVersion () {\n  return __VERSION__\n}\n\nexport function getGlobal () {\n  /* eslint-disable */\n  return Function('return this')()\n}\n\nfunction base64ToBinary (base64String: string): string {\n  const padding = '='.repeat((4 - base64String.length % 4) % 4)\n  const base64 = (base64String + padding)\n    .replace(/-/g, '+')\n    .replace(/_/g, '/')\n\n  return atob(base64)\n}\n\nexport function urlB64ToUint8Array (base64String: string): Uint8Array {\n  const rawData = base64ToBinary(base64String)\n  const outputArray = new Uint8Array(rawData.length)\n\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i)\n  }\n\n  return outputArray\n}\n\nexport function urlB64ToString (base64String: string): string {\n  return base64ToBinary(base64String)\n}\n\nexport async function isDeviceRegistered (meWebPushDb: MEWebPushDb): Promise<boolean> {\n  const { exists, pushTokenExists } = await checkDevice(meWebPushDb)\n  const hasPushToken = pushTokenExists !== undefined ? pushTokenExists : false\n  return (exists && hasPushToken)\n}\n\n/**\n * Returns basic information about registration, push token and identified contact\n * based on the content of the client state\n */\nexport async function checkDevice (meWebPushDb: MEWebPushDb): Promise<DeviceCheckResult> {\n  const clientId = await meWebPushDb.getClientId()\n\n  if (!clientId) {\n    return { exists: false }\n  }\n\n  const clientState = await meWebPushDb.getClientState()\n  if (!clientState) {\n    return { exists: false }\n  }\n\n  const decodedClientState = JWT.decode(clientState)\n  if (!decodedClientState) {\n    return { exists: false }\n  }\n\n  const pushToken = decodedClientState.pushToken || null\n  const contactField = decodedClientState.contactField || null\n  return {\n    exists: true,\n    pushTokenExists: pushToken !== null,\n    identified: contactField !== null\n  }\n}\n\nexport const payloadMessageDataProperties: {[index: string]: string} = {\n  id: 'string',\n  sid: 'string',\n  applicationCode: 'string',\n  notificationSettings: 'object'\n}\n\n/**\n * Check if the WebPush Message payload is produced by Emarsys.\n * @param payload\n * @returns true if it is an Emarsys Payload\n */\nexport function isValidPayload (payload: any): boolean {\n  if (typeof payload !== 'object') return false\n  const emarsysPayload = payload.messageData\n  if (!emarsysPayload) return false\n  const isValidProperty = (prop: string) => {\n    return emarsysPayload[prop]\n      ? (typeof emarsysPayload[prop]) === payloadMessageDataProperties[prop]\n      : false\n  }\n  const result = Object.keys(payloadMessageDataProperties)\n    .map(isValidProperty)\n    .reduce((acc, r) => acc && r, true)\n  return result\n}\n\n/**\n * Checks the passed data and returns either the ContactInfo or undefined if the data does not fit\n * @param contactInfo The data which shall be converted\n */\nexport function toContactInfo (contactInfo?: {} | ContactInfo | undefined): ContactInfo | undefined {\n  if (contactInfo === undefined || Object.keys(contactInfo).length !== 3) {\n    return undefined\n  }\n  return contactInfo as ContactInfo\n}\n\nexport const isEmptyObject = (obj: any) => {\n  if (obj === null) return true\n  /* eslint-disable */\n  if (obj === undefined) return true\n  for (const property in obj) {\n    return false\n  }\n  return true\n}\n\nexport function determineServiceWorkerScope (params?: ServiceWorkerParams): string | undefined {\n  if (params) {\n    return params.scope\n  } else {\n    return undefined\n  }\n}\n","import logging from './logging'\nimport { MEWebPushDb } from './me-web-push-db'\nconst { Logger } = logging\n\ntype Params = {\n  level?: string\n  message?: string\n}\n\nexport class StorageWithLog {\n  private readonly storage: MEWebPushDb\n\n  constructor (storage: MEWebPushDb) {\n    this.storage = storage\n  }\n\n  private log (value: string | undefined, defaultMessage: string, params?: Params) {\n    const { level = 'error', message = defaultMessage } = params ?? {}\n    if (!value) Logger[level](message)\n    return value\n  }\n\n  async getClientId (params?: Params): Promise<string | undefined> {\n    const defaultMessage = 'Error: No client ID set for the browser!'\n    const clientId = await this.storage.getClientId()\n    return this.log(clientId, defaultMessage, params)\n  }\n\n  async getContactToken (params?: Params): Promise<string | undefined> {\n    const defaultMessage = 'Error: No contact token set!'\n    const contactToken = await this.storage.getContactToken()\n    return this.log(contactToken, defaultMessage, params)\n  }\n\n  async getClientState (params?: Params): Promise<string | undefined> {\n    const defaultMessage = 'Error: No client state set!'\n    const clientState = await this.storage.getClientState()\n    return this.log(clientState, defaultMessage, params)\n  }\n\n  async getRefreshToken (params?: Params): Promise<string | undefined> {\n    const defaultMessage = 'Unable to refresh contact token a refresh-token is missing!'\n    const refreshToken = await this.storage.getRefreshToken()\n    return this.log(refreshToken, defaultMessage, params)\n  }\n}\n","import { urlB64ToString } from './utils'\nimport logging from './logging'\n\nexport type DecodeOptions = {\n  header?: boolean\n}\n\nexport type DecodedToken = { [key: string]: any }\n\nexport function decode (token: string, options?: DecodeOptions): DecodedToken | null {\n  const opts = options ?? {}\n  const pos = opts.header === true ? 0 : 1\n  try {\n    return JSON.parse(urlB64ToString(token.split('.')[pos]))\n  } catch (err) {\n    logging.Logger.error('Error decoding token', err)\n    return null\n  }\n}\n","import logging from './logging'\nimport { MEV3ApiRequest } from './me-v3-api-request'\nimport { MEWebPushDb } from './me-web-push-db'\nimport { StorageWithLog } from './storage-with-log'\n\nconst { Logger } = logging\n\ntype MEEventType = 'internal' | 'custom' | 'other'\n\nexport type WebPushTreatments = {\n  ac?: { id: number, run_id: string }\n  rti?: { id: string, run_id: string }\n  ui?: { id: number, run_id: string }\n  ui_test?: { id: number, run_id: string }\n}\n\nexport type MEEventAttributes = Record<string, string>\n\nexport type MEEvent = {\n  type: MEEventType\n  name: string\n  timestamp: string\n  attributes?: MEEventAttributes\n}\n\n/**\n * The data we send\n */\nexport type MEEventsRequestData = {\n  dnd?: boolean\n  events: MEEvent[]\n  viewedMessages: any[]\n  clicks: any[]\n}\n\nexport type ClientDetails = {\n  platform: string\n  applicationVersion?: string\n  deviceModel?: string\n  osVersion?: string\n  sdkVersion?: string\n  language?: string\n  timezone?: string\n}\n\nexport type PostEventsResult = { success: boolean, statusCode?: number }\n\nconst PostEventsOKStates = [200, 204]\n\nexport class MEDeviceEventService {\n  private storage: MEWebPushDb\n  private readonly storageWithLog: StorageWithLog\n  private readonly baseUrl: string\n  private desRequest: MEV3ApiRequest\n\n  constructor (\n    baseUrl: string,\n    desRequest: MEV3ApiRequest,\n    storage: MEWebPushDb\n  ) {\n    this.storage = storage\n    this.storageWithLog = new StorageWithLog(storage)\n    this.baseUrl = `${baseUrl}/apps`\n    this.desRequest = desRequest\n  }\n\n  /**\n   * Post the passed data which includes 1 or more events to the device event service\n   * @param eventsData The events which shall be forwarded to the DES.\n   * @returns A promise which resolves to a PostEventsResult which indicates the success\n   *          of the operation and contains the returned status code.\n   */\n  async postEvents (eventsData: MEEventsRequestData): Promise<PostEventsResult> {\n    const clientId = await this.storageWithLog.getClientId()\n    const contactToken = await this.storageWithLog.getContactToken()\n    const clientState = await this.storageWithLog.getClientState()\n    if (!clientId || !contactToken || !clientState) {\n      return { success: false }\n    }\n    const apiEndpoint = await this.apiEndpoint('client/events')\n    const response = await this.desRequest.post(apiEndpoint, eventsData, { clientId, clientState, contactToken })\n    if (PostEventsOKStates.includes(response.status)) {\n      return { success: true, statusCode: response.status }\n    } else {\n      const body = await response.json()\n      Logger.warn('Error posting events to device event service', response.status, JSON.stringify(body))\n      return { success: false, statusCode: response.status }\n    }\n  }\n\n  private async apiEndpoint (path: string): Promise<string> {\n    const appCode = await this.storage.getAppCode()\n    return `${this.baseUrl}/${appCode!}/${path}`\n  }\n\n  static create (\n    baseUrl: string,\n    desRequest: MEV3ApiRequest,\n    storage: MEWebPushDb\n  ) {\n    return new MEDeviceEventService(baseUrl, desRequest, storage)\n  }\n}\n","import logging from './logging'\nimport { MEV3ApiRequest } from './me-v3-api-request'\nimport { MEWebPushDb } from './me-web-push-db'\nimport { StorageWithLog } from './storage-with-log'\n\nconst { Logger } = logging\n\ntype ContactRequestBodyData = {\n  anonymous: boolean\n  body: { contactFieldId: number, contactFieldValue: string, contactFieldEncrypted: boolean } |\n  { contactFieldId: number, openIdToken: string } | {}\n}\n\nexport type ClientDetails = {\n  platform: string\n  applicationVersion?: string\n  deviceModel?: string\n  osVersion?: string\n  sdkVersion?: string\n  language?: string\n  timezone?: string\n}\n\nexport class MEClientService {\n  private readonly storage: MEWebPushDb\n  private readonly storageWithLog: StorageWithLog\n  private readonly baseUrl: string\n  private meClientServiceRequest: MEV3ApiRequest\n\n  constructor (\n    baseUrl: string,\n    meClientServiceRequest: MEV3ApiRequest,\n    storage: MEWebPushDb\n  ) {\n    this.storage = storage\n    this.storageWithLog = new StorageWithLog(storage)\n    this.baseUrl = `${baseUrl}/domains`\n    this.meClientServiceRequest = meClientServiceRequest\n  }\n\n  /**\n   * Create or update the information which is related to a specific browser\n   */\n  async storeClientDetails (): Promise<boolean> {\n    const clientId = await this.storageWithLog.getClientId()\n    if (!clientId) {\n      return false\n    }\n    const apiEndpoint = await this.apiEndpoint('client')\n    const clientState = await this.storage.getClientState()\n    const clientDetails = await this.getClientDetails()\n    const response = await this.meClientServiceRequest.post(apiEndpoint, clientDetails, { clientId, clientState })\n    if (response.status === 204) {\n      await this.saveClientState(response)\n      return true\n    } else {\n      const body = await response.json()\n      Logger.error('Error storing client info', response.status, JSON.stringify(body))\n      return false\n    }\n  }\n\n  async linkClientToContact (contactInfo?: ContactInfo | OpenIdContactInfo): Promise<boolean> {\n    const clientId = await this.storageWithLog.getClientId()\n    const clientState = await this.storageWithLog.getClientState({ level: 'info' })\n    if (!clientId || !clientState) {\n      return false\n    }\n    const { anonymous, body } = this.toContactRequestBodyData(contactInfo)\n    const apiEndpoint = `${await this.apiEndpoint('client/contact')}${anonymous ? '?anonymous=true' : ''}`\n    const response = await this.meClientServiceRequest.post(apiEndpoint, body, { clientId, clientState })\n    if (response.status === 200) {\n      await this.saveClientState(response)\n      const responseBody = await response.json()\n      if (responseBody.contactToken && responseBody.refreshToken) {\n        await Promise.all([\n          this.storage.setContactToken(responseBody.contactToken),\n          this.storage.setRefreshToken(responseBody.refreshToken)\n        ])\n        return true\n      } else {\n        Logger.error('At least one of the expected response parts missing!')\n        return false\n      }\n    } else {\n      const body = await response.json()\n      Logger.error('Error linking contact to client', response.status, JSON.stringify(body))\n      return false\n    }\n  }\n\n  async generateAccessToken (): Promise<boolean> {\n    const clientId = await this.storageWithLog.getClientId()\n    const refreshToken = await this.storageWithLog.getRefreshToken()\n    const clientState = await this.storageWithLog.getClientState()\n    if (!clientId || !refreshToken || !clientState) {\n      return false\n    }\n    const apiEndpoint = await this.apiEndpoint('client/contact-token')\n    const body = { refreshToken }\n    const response = await this.meClientServiceRequest.post(apiEndpoint, body, { clientId, clientState })\n    if (response.status === 200) {\n      const responseBody = await response.json()\n      if (responseBody.contactToken) {\n        await this.storage.setContactToken(responseBody.contactToken)\n        return true\n      } else {\n        Logger.error('ContactToken is not part of response body!')\n        return false\n      }\n    } else {\n      const body = await response.json()\n      Logger.log('Error refreshing the contact token', response.status, JSON.stringify(body))\n      return false\n    }\n  }\n\n  async registerPushToken (pushToken: string): Promise<boolean> {\n    const clientId = await this.storageWithLog.getClientId()\n    const clientState = await this.storageWithLog.getClientState()\n    const contactToken = await this.storageWithLog.getContactToken({ message: 'Unable to register subscription as contactToken is missing!' })\n    if (!clientId || !clientState || !contactToken) {\n      return false\n    }\n\n    const apiEndpoint = await this.apiEndpoint('client/push-token')\n    const body = { pushToken }\n    const response = await this.meClientServiceRequest.put(apiEndpoint, body, { clientId, clientState, contactToken })\n    if (response.status === 204) {\n      await this.saveClientState(response)\n      return true\n    } else {\n      const body = await response.json()\n      Logger.error('Error registering the subscription', response.status, JSON.stringify(body))\n      return false\n    }\n  }\n\n  async removePushToken (): Promise<boolean> {\n    Logger.info('Remove push token')\n    const clientId = await this.storageWithLog.getClientId()\n    const clientState = await this.storageWithLog.getClientState({ level: 'info' })\n    const contactToken = await this.storageWithLog.getContactToken({ level: 'info' })\n    if (!clientId || !clientState || !contactToken) {\n      return false\n    }\n    const apiEndpoint = await this.apiEndpoint('client/push-token')\n    const response = await this.meClientServiceRequest.delete(apiEndpoint, {}, { clientId, clientState, contactToken })\n    if (response.status === 204) {\n      await this.saveClientState(response)\n      return true\n    } else {\n      const body = await response.json()\n      Logger.error('Error removing a subscription', response.status, JSON.stringify(body))\n      return true\n    }\n  }\n\n  private async apiEndpoint (path: string): Promise<string> {\n    const appCode = await this.storage.getAppCode()\n    return `${this.baseUrl}/${appCode!}/${path}`\n  }\n\n  private async saveClientState (response: Response) {\n    const clientState = response.headers.get('x-client-state')\n    if (clientState) {\n      await this.storage.setClientState(clientState)\n    } else {\n      Logger.error('Error: X-Client-State not found in response header!')\n    }\n  }\n\n  private async getClientDetails (): Promise<ClientDetails> {\n    const platform = await this.storage.getPlatform()\n    if (platform) {\n      const applicationVersion = await this.storage.getApplicationVersion()\n      const deviceModel = await this.storage.getDeviceModel()\n      const osVersion = await this.storage.getOsVersion()\n      const sdkVersion = await this.storage.getSdkVersion()\n      const language = await this.storage.getLanguage()\n      const timezone = await this.storage.getTimezone()\n      return {\n        platform,\n        applicationVersion,\n        deviceModel,\n        osVersion,\n        sdkVersion,\n        language,\n        timezone\n      }\n    } else {\n      throw new Error('platform not found in storage!')\n    }\n  }\n\n  private toContactRequestBodyData (contactInfo?: ContactInfo | OpenIdContactInfo): ContactRequestBodyData {\n    if (!contactInfo) {\n      return {\n        body: {},\n        anonymous: true\n      }\n    }\n\n    if ('openIdToken' in contactInfo) {\n      return {\n        body: {\n          contactFieldId: contactInfo.fieldId,\n          openIdToken: contactInfo.openIdToken\n        },\n        anonymous: false\n      }\n    }\n\n    return {\n      body: {\n        contactFieldId: contactInfo.fieldId,\n        contactFieldValue: contactInfo.fieldValue,\n        contactFieldEncrypted: contactInfo.encrypted\n      },\n      anonymous: false\n    }\n  }\n\n  static create (\n    baseUrl: string,\n    meClientServiceRequest: MEV3ApiRequest,\n    storage: MEWebPushDb\n  ) {\n    return new MEClientService(baseUrl, meClientServiceRequest, storage)\n  }\n}\n","const defaultHeaders: { [key: string]: string } = {\n  'Content-Type': 'application/json'\n}\n\nexport type HeaderData = {\n  clientId: string\n  clientState?: string\n  contactToken?: string\n}\n\nexport class MEV3ApiRequest {\n  private requestOrder: number\n\n  constructor () {\n    this.requestOrder = 0\n  }\n\n  async post (endpoint: string, body: object, headerData: HeaderData): Promise<Response> {\n    const requestInit: RequestInit = this.createPostRequestInit(body, headerData)\n    return fetch(endpoint, requestInit)\n  }\n\n  async put (endpoint: string, body: object, headerData: HeaderData): Promise<Response> {\n    const requestInit: RequestInit = this.createPutRequestInit(body, headerData)\n    return fetch(endpoint, requestInit)\n  }\n\n  async delete (endpoint: string, body: object, headerData: HeaderData): Promise<Response> {\n    const requestInit: RequestInit = this.createDeleteRequestInit(body, headerData)\n    return fetch(endpoint, requestInit)\n  }\n\n  private createPostRequestInit (body: object, headerData: HeaderData): RequestInit {\n    return this.createRequestInit('POST', body, headerData)\n  }\n\n  private createPutRequestInit (body: object, headerData: HeaderData): RequestInit {\n    return this.createRequestInit('PUT', body, headerData)\n  }\n\n  private createDeleteRequestInit (body: object, headerData: HeaderData): RequestInit {\n    return this.createRequestInit('DELETE', body, headerData)\n  }\n\n  private createRequestInit (method: string, body: object, headerData: HeaderData): RequestInit {\n    return {\n      method,\n      headers: this.buildHeaders(headerData),\n      mode: 'cors',\n      cache: 'default',\n      body: JSON.stringify(body)\n    }\n  }\n\n  private buildHeaders (headerData: HeaderData) {\n    const headers: Headers = new Headers()\n\n    Object.keys(defaultHeaders).forEach(k => {\n      headers.append(k, defaultHeaders[k])\n    })\n\n    headers.append('x-client-id', headerData.clientId)\n\n    if (headerData.clientState) {\n      headers.append('x-client-state', headerData.clientState)\n    }\n\n    if (headerData.contactToken) {\n      headers.append('x-contact-token', headerData.contactToken)\n    }\n\n    headers.append('x-request-order', `${this.requestOrder}`)\n    this.requestOrder += 1\n\n    return headers\n  }\n\n  static create (): MEV3ApiRequest {\n    return new MEV3ApiRequest()\n  }\n}\n","import * as CONSTANTS from './constants'\nimport { IndexDb } from './index-db'\n\n/**\n * The ME web push persisted information\n */\nexport class MEWebPushDb {\n  private readonly indexDb: IndexDb\n  private appCode: string | undefined\n\n  constructor (indexDb: IndexDb) {\n    this.indexDb = indexDb\n  }\n\n  async getDefaultNotificationTitle (defaultTitle: string): Promise<string> {\n    return (this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyDefaultNotificationTitle, defaultTitle) as Promise<string>)\n  }\n\n  async getDefaultNotificationIcon (defaultImage: string | undefined): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyDefaultNotificationIcon, defaultImage)\n  }\n\n  async getClientIdForAppCode (appCode: string | undefined): Promise<string | undefined> {\n    if (appCode !== undefined) {\n      const browserIds: ClientIdList = await this.getBrowserIdsFromDb()\n      return browserIds[appCode.toUpperCase()]\n    }\n  }\n\n  async getClientIds (): Promise<ClientIdList | undefined> {\n    return this.getBrowserIdsFromDb()\n  }\n\n  private async getBrowserIdsFromDb (): Promise<ClientIdList> {\n    const browserIdsString: string | undefined = await this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyBrowserIds)\n    let browserIds: { [appCode: string]: string } = {}\n    if (browserIdsString !== undefined) {\n      // tslint:disable-next-line:no-empty\n      try { browserIds = JSON.parse(browserIdsString) } catch (err) { }\n    }\n    browserIds = await this.addLegacyBrowserId(browserIds)\n    return browserIds\n  }\n\n  private async addLegacyBrowserId (browserIds: ClientIdList): Promise<ClientIdList> {\n    const legacyBrowserId = await this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyBrowserId)\n    if (legacyBrowserId !== undefined) {\n      const parts = legacyBrowserId.split('_')\n      browserIds[parts[0].toUpperCase()] = legacyBrowserId\n      await this.indexDb.setDBValue(CONSTANTS.dbKeyBrowserIds, JSON.stringify(browserIds))\n      await this.indexDb.setDBValue(CONSTANTS.dbKeyBrowserId, undefined)\n    }\n    return browserIds\n  }\n\n  async getInitParams (): Promise<IInitParams | undefined> {\n    const params = await this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyInitParams)\n    return params ? JSON.parse(params) : undefined\n  }\n\n  async getMeClientServiceApiBaseUrl (): Promise<string> {\n    return this.indexDb.getDBValue(CONSTANTS.dbKeyMeClientServiceApiBaseUrl)\n  }\n\n  async getMeDeviceEventServiceApiBaseUrl (): Promise<string> {\n    return this.indexDb.getDBValue(CONSTANTS.dbKeyMeDeviceEventServiceApiBaseUrl)\n  }\n\n  async getClientId (): Promise<string | undefined> {\n    const appCode = await this.getAppCode()\n    return this.getClientIdForAppCode(appCode)\n  }\n\n  async getClientState (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyXClientState)\n  }\n\n  async getRefreshToken (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyRefreshToken)\n  }\n\n  async getContactToken (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyContactToken)\n  }\n\n  async getAppCode (): Promise<string | undefined> {\n    if (!this.appCode) {\n      this.appCode = await this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyApplicationCode)\n    }\n    return this.appCode\n  }\n\n  async getWebsitePushId (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyWebsitePushId)\n  }\n\n  async getLastPermissionStatus (): Promise<NotificationPermission | undefined> {\n    return this.indexDb\n      .getDBValueOrDefault(CONSTANTS.dbKeyLastPermissionStatus)\n      .then(v => v as NotificationPermission)\n  }\n\n  async getApplicationServerPublicKey (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyApplicationServerPublicKey)\n  }\n\n  async getServiceWorkerUrl (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyServiceWorkerUrl)\n  }\n\n  async getServiceWorkerScope (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyServiceWorkerScope)\n  }\n\n  async getSdkVersion (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeySdkVersion)\n  }\n\n  async getServiceWorkerVersion (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyServiceWorkerVersion)\n  }\n\n  async getPushToken (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyPushToken)\n  }\n\n  async getContactFieldId (): Promise<number | undefined> {\n    const fieldId = await this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyContactFieldId)\n    return fieldId ? Number(fieldId) : undefined\n  }\n\n  async getContactFieldValue (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyContactFieldValue)\n  }\n\n  async getPushPackageServiceUrl (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyPushPackageServiceUrl)\n  }\n\n  async getPlatform (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyPlatform)\n  }\n\n  async getApplicationVersion (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyApplicationVersion)\n  }\n\n  async getDeviceModel (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyDeviceModel)\n  }\n\n  async getOsVersion (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyOsVersion)\n  }\n\n  async getLanguage (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyLanguage)\n  }\n\n  async getTimezone (): Promise<string | undefined> {\n    return this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyTimezone)\n  }\n\n  async getLoggingEnabled (): Promise<boolean> {\n    const flag = await this.indexDb.getDBValueOrDefault(CONSTANTS.dbKeyLoggingEnabled)\n    return flag?.toLowerCase() === 'true'\n  }\n\n  async setTimezone (value: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyTimezone, value)\n  }\n\n  async setLanguage (value: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyLanguage, value)\n  }\n\n  async setOsVersion (value: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyOsVersion, value)\n  }\n\n  async setDeviceModel (value: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyDeviceModel, value)\n  }\n\n  async setApplicationVersion (value: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyApplicationVersion, value)\n  }\n\n  async setPlatform (value: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyPlatform, value)\n  }\n\n  async setPushPackageServiceUrl (url: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyPushPackageServiceUrl, url)\n  }\n\n  async setContactFieldValue (fieldValue: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyContactFieldValue, fieldValue)\n  }\n\n  async setContactFieldId (fieldId: number | undefined): Promise<void> {\n    await this.indexDb.setDBValue(\n      CONSTANTS.dbKeyContactFieldId,\n      typeof fieldId === 'number' ? fieldId.toString() : undefined\n    )\n  }\n\n  async setMeClientServiceApiBaseUrl (url: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyMeClientServiceApiBaseUrl, url)\n  }\n\n  async setMeDeviceEventServiceApiBaseUrl (url: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyMeDeviceEventServiceApiBaseUrl, url)\n  }\n\n  async setPushToken (pushToken: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyPushToken, pushToken)\n  }\n\n  async setServiceWorkerVersion (version: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyServiceWorkerVersion, version)\n  }\n\n  async setSdkVersion (sdkVersion: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeySdkVersion, sdkVersion)\n  }\n\n  async setLastPermissionStatus (status: NotificationPermission | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyLastPermissionStatus, status)\n  }\n\n  async setAppCode (appCode: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyApplicationCode, appCode)\n    this.appCode = appCode\n  }\n\n  async setClientState (clientState: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyXClientState, clientState)\n  }\n\n  async setContactToken (contactToken: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyContactToken, contactToken)\n  }\n\n  async setRefreshToken (refreshToken: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyRefreshToken, refreshToken)\n  }\n\n  private async setClientId (clientId: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyBrowserId, clientId)\n  }\n\n  async setClientIdForAppCode (clientId: string | undefined, appCode: string): Promise<void> {\n    const browserIds = await this.getBrowserIdsFromDb()\n    if (clientId !== undefined) {\n      browserIds[appCode.toUpperCase()] = clientId\n    } else {\n      // eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n      delete browserIds[appCode.toUpperCase()]\n    }\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyBrowserIds, JSON.stringify(browserIds))\n  }\n\n  async setClientIds (clientIds: ClientIdList | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyBrowserIds, JSON.stringify(clientIds))\n  }\n\n  async setDefaultNotificationIcon (icon: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyDefaultNotificationIcon, icon)\n  }\n\n  async setDefaultNotificationTitle (icon: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyDefaultNotificationTitle, icon)\n  }\n\n  async setServiceWorkerUrl (url: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyServiceWorkerUrl, url)\n  }\n\n  async setServiceWorkerScope (scope: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyServiceWorkerScope, scope)\n  }\n\n  async setApplicationServerPublicKey (key: string | undefined): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyApplicationServerPublicKey, key)\n  }\n\n  async setInitParams (params: IInitParams | undefined) {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyInitParams, JSON.stringify(params))\n  }\n\n  async setWebsitePushId (id: string | undefined) {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyWebsitePushId, id)\n  }\n\n  async setLoggingEnabled (flag: boolean): Promise<void> {\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyLoggingEnabled, `${flag}`)\n  }\n\n  async setLastUsedAt (): Promise<void> {\n    const d = new Date().toISOString()\n    await this.indexDb.setDBValue(CONSTANTS.dbKeyLastUsedAt, d)\n  }\n\n  async deleteLastUsedAt (): Promise<void> {\n    await this.indexDb.deleteDBKey(CONSTANTS.dbKeyLastUsedAt)\n  }\n\n  async clearAll (): Promise<void> {\n    await Promise.all([\n      this.setAppCode(undefined),\n      this.setClientState(undefined),\n      this.setContactToken(undefined),\n      this.setRefreshToken(undefined),\n      this.setDefaultNotificationIcon(undefined),\n      this.setDefaultNotificationTitle(undefined),\n      this.setServiceWorkerUrl(undefined),\n      this.setServiceWorkerScope(undefined),\n      this.setApplicationServerPublicKey(undefined),\n      this.setSdkVersion(undefined),\n      this.setServiceWorkerVersion(undefined),\n      this.setInitParams(undefined),\n      this.setWebsitePushId(undefined),\n      this.setPushPackageServiceUrl(undefined),\n      this.setLastPermissionStatus(undefined),\n      this.setPushToken(undefined),\n      this.setContactFieldId(undefined),\n      this.setContactFieldValue(undefined),\n      this.setPlatform(undefined),\n      this.setApplicationVersion(undefined),\n      this.setDeviceModel(undefined),\n      this.setTimezone(undefined),\n      this.setLanguage(undefined),\n      this.setOsVersion(undefined),\n      this.setMeClientServiceApiBaseUrl(undefined),\n      this.setMeDeviceEventServiceApiBaseUrl(undefined),\n      this.deleteLastUsedAt()\n    ])\n    this.appCode = undefined // clear the cache\n  }\n\n  static create (indexDb: IndexDb): MEWebPushDb {\n    return new MEWebPushDb(indexDb)\n  }\n}\n","import { indexedDbName, indexedDbVersion } from './constants'\n\nconst NotFoundMessage = 'not_found'\n\n/**\n * IndexedDb class handles browser's indexdb database operations\n */\nexport class IndexDb {\n  private name: string\n  private indexedDBInstance: IDBDatabase | undefined\n\n  constructor () {\n    this.name = 'keyValue'\n  }\n\n  /**\n   * Saves a value to browser's indexDb with a given key\n   */\n  async setDBValue (key: string, value: string | undefined): Promise<string> {\n    return this.openIndexDB().then((database: IDBDatabase) => {\n      return new Promise((resolve, reject) => {\n        const request = database\n          .transaction([this.name], 'readwrite')\n          .objectStore(this.name)\n          .put({ key, value })\n\n        request.onsuccess = () => {\n          this.indexedDBInstance = undefined\n          database.close()\n          return resolve(key)\n        }\n\n        request.onerror = (e) => {\n          this.indexedDBInstance = undefined\n          database.close()\n          return reject(e)\n        }\n      })\n    })\n  }\n\n  /**\n   * Saves a value to browser's indexDb with a given key\n   */\n  async deleteDBKey (key: IDBValidKey): Promise<boolean> {\n    return this.openIndexDB().then((database: IDBDatabase) => {\n      return new Promise((resolve, reject) => {\n        const request = database\n          .transaction([this.name], 'readwrite')\n          .objectStore(this.name)\n          .delete(key)\n\n        request.onsuccess = () => {\n          this.indexedDBInstance = undefined\n          database.close()\n          return resolve(true)\n        }\n\n        request.onerror = (e) => {\n          this.indexedDBInstance = undefined\n          database.close()\n          return reject(e)\n        }\n      })\n    })\n  }\n\n  /**\n   * Read a value from browser's indexDb\n   */\n  async getDBValue (key: string): Promise<string> {\n    const database: IDBDatabase = await this.openIndexDB()\n    return new Promise((resolve, reject) => {\n      const request = database\n        .transaction(this.name)\n        .objectStore(this.name)\n        .get(key)\n\n      request.onsuccess = () => {\n        const { result } = request\n        if (result) {\n          this.indexedDBInstance = undefined\n          database.close()\n          return resolve(result.value)\n        } else {\n          this.indexedDBInstance = undefined\n          database.close()\n          return reject(new Error(NotFoundMessage))\n        }\n      }\n\n      request.onerror = (event: Event) => {\n        this.indexedDBInstance = undefined\n        database.close()\n        return reject(event)\n      }\n    })\n  }\n\n  /**\n   * Read a value from browser's indexDb with fallback\n   */\n  async getDBValueOrDefault (key: string, defaultVal: string | undefined = undefined): Promise<string | undefined> {\n    try {\n      const result = await this.getDBValue(key)\n      return result\n    } catch (err) {\n      if (err.message === NotFoundMessage) {\n        return defaultVal\n      } else {\n        throw err\n      }\n    }\n  }\n\n  /**\n   * Opens browser's IndexDB database.\n   * If the database has opened already it doesn't reopen it but returns with the opened one.\n   */\n  private async openIndexDB (): Promise<IDBDatabase> {\n    return new Promise((resolve, reject) => {\n      if (this.indexedDBInstance) {\n        return resolve(this.indexedDBInstance)\n      }\n      const request = indexedDB.open(indexedDbName, indexedDbVersion)\n\n      request.onsuccess = (event: Event) => {\n        this.indexedDBInstance = (event.target! as any).result\n        return resolve(this.indexedDBInstance)\n      }\n\n      request.onerror = (event: Event) => {\n        return reject(event)\n      }\n\n      request.onupgradeneeded = (event: Event) => {\n        const database = (event.target! as any).result\n        database.createObjectStore('keyValue', {\n          keyPath: 'key'\n        })\n      }\n    })\n  }\n\n  static create (): IndexDb {\n    return new IndexDb()\n  }\n}\n","import { EmarsysServiceWorker } from './lib/emarsys-service-worker'\nimport { MEWebPushDb } from './lib/me-web-push-db'\nimport { IndexDb } from './lib/index-db'\n\nconst webPushDb = MEWebPushDb.create(IndexDb.create())\nconst worker = EmarsysServiceWorker.create(webPushDb)\n\nself.addEventListener('push', event => { console.log(event); worker.onPush(event as PushEvent) })\nself.addEventListener('notificationclick', event => worker.onNotificationClick(event as NotificationEvent))\nself.addEventListener('install', event => worker.onInstall(event as ExtendableEvent))\nself.addEventListener('pushsubscriptionchange',\n  event => worker.onSubscriptionChange(event as PushSubscriptionChangeEvent)\n)\n","import logging from './logging'\nimport {\n  pushActionsProperty,\n  pushIconProperty,\n  pushImageProperty,\n  pushLinkProperty,\n  pushTitleProperty\n} from './constants'\nimport { isValidPayload } from './utils'\nimport { MEWebPushDb } from './me-web-push-db'\nimport {\n  MEDeviceEventService,\n  MEEvent,\n  MEEventAttributes,\n  MEEventsRequestData,\n  PostEventsResult,\n  WebPushTreatments\n} from './me-device-event-service'\nimport { MEClientService } from './me-client-service'\nimport { MEV3ApiRequest } from './me-v3-api-request'\n\ndeclare const self: ServiceWorkerGlobalScope\n\ntype ActionButton = {\n  id: string\n  title: string\n  url: string\n}\n\ntype DbFallbackFn<T> = () => Promise<T | undefined>\ntype NotificationData<T> = { [key: string]: T }\n\nconst FailureResult: PostEventsResult = { success: false }\n\n/**\n * EmarsysServiceWorker class is responsible for receiving push notifications and shows the notification.\n */\nexport class EmarsysServiceWorker {\n  private webPushDb: MEWebPushDb\n  private meDeviceEventService?: MEDeviceEventService\n  private meClientService?: MEClientService\n\n  constructor (\n    webPushDb: MEWebPushDb\n  ) {\n    this.webPushDb = webPushDb\n  }\n\n  onInstall (event: ExtendableEvent): void {\n    event.waitUntil(this.handleInstall())\n  }\n\n  onPush (event: PushEvent): void {\n    event.waitUntil(this._onPush(event))\n  }\n\n  onNotificationClick (event: NotificationEvent): void {\n    event.waitUntil(this._onNotificationClick(event))\n  }\n\n  onSubscriptionChange (event: PushSubscriptionChangeEvent): void {\n    event.waitUntil(this._onSubscriptionChange())\n  }\n\n  private async _onPush (event: PushEvent): Promise<any> {\n    await this.setupLogging()\n\n    if (!('showNotification' in self.registration)) {\n      logging.Logger.warn('Showing of notifications is not enabled')\n      return\n    }\n    console.log(event)\n    // eslint-disable-next-line\n    const payloadJson = event.data && event.data.json() ? event.data.json() : {}\n    console.log(payloadJson)\n    if (!isValidPayload(payloadJson)) {\n      logging.Logger.warn('Invalid payload', payloadJson)\n      return\n    }\n    // @ts-expect-error\n    const notificationSettings = payloadJson.messageData.notificationSettings\n    return Promise.all([\n      this.getNotificationOption(\n      // @ts-expect-error\n        payloadJson, pushTitleProperty, () => this.webPushDb.getDefaultNotificationTitle('')\n      ),\n      this.getNotificationOption(\n        notificationSettings, pushIconProperty, () => this.webPushDb.getDefaultNotificationIcon(undefined)\n      ),\n      this.getNotificationOption(\n        notificationSettings, pushImageProperty, () => Promise.resolve(undefined)\n      ),\n      this.getNotificationOption<ActionButton[]>(\n        notificationSettings, pushActionsProperty, () => Promise.resolve(undefined)\n      )\n    ]).then(\n      ([notificationTitle, notificationIcon, notificationImage, notificationActions]:\n      [string | undefined, string | undefined, string | undefined, ActionButton[] | undefined]) => {\n        console.log(payloadJson)\n        return this.showNotification(\n          // @ts-expect-error\n          payloadJson.message,\n          payloadJson,\n          notificationTitle as string,\n          notificationIcon,\n          notificationImage,\n          notificationActions ? this.createActionsFromActionButtons(notificationActions) : notificationActions\n        )\n      })\n  }\n\n  private async _onNotificationClick (event: NotificationEvent): Promise<any> {\n    await this.setupLogging()\n\n    logging.Logger.debug(`Notification clicked with Action: ${event.action}`)\n\n    event.notification.close()\n    const payload = event.notification.data\n\n    if (!payload.messageData.notificationSettings) {\n      return\n    }\n\n    let url = payload.messageData.notificationSettings[pushLinkProperty]\n\n    if (payload.messageData.notificationSettings[pushActionsProperty]) {\n      const buttonClicked = payload.messageData.notificationSettings[pushActionsProperty]\n        .find((actionButton: ActionButton) => actionButton.id === event.action)\n\n      if (buttonClicked) {\n        url = buttonClicked.url\n      }\n    }\n    // eslint-disable-next-line\n    const commands: Promise<unknown>[] = []\n\n    if (url) {\n      // eslint-disable-next-line\n      logging.Logger.debug(`Opening url: ${url}`)\n      commands.push(self.clients.openWindow(url))\n    }\n    commands.push(this.reportOpen(payload))\n\n    return Promise.all(commands)\n  }\n\n  private async _onSubscriptionChange (): Promise<any> {\n    try {\n      await this.setupLogging()\n      logging.Logger.debug('Subscription changed')\n\n      const applicationServerKey = await this.getApplicationServerKey()\n      logging.Logger.debug('Got applicationServerKey', JSON.stringify(applicationServerKey))\n\n      if (!applicationServerKey) {\n        logging.Logger.debug('Exiting registerNewSubscription')\n        return\n      }\n\n      logging.Logger.debug('Subscribing for new key')\n      const subscription: PushSubscription = await self.registration.pushManager\n        .subscribe({ userVisibleOnly: true, applicationServerKey })\n      logging.Logger.debug('Registering new subscription', subscription)\n      // eslint-disable-next-line\n      return this.registerNewSubscription(subscription, false)\n    } catch (err) {\n      logging.Logger.error('onSubscriptionChange: registerSubscription', err)\n    }\n  }\n\n  private async registerNewSubscription (\n    subscription: PushSubscription,\n    isRetry: boolean = false\n  ): Promise<void> {\n    const meClientSvc = await this.getMeClientService()\n    if (!meClientSvc) {\n      logging.Logger.error('Unable to get the ME client service!')\n      return\n    }\n    let success = await meClientSvc.registerPushToken(JSON.stringify(subscription))\n    if (success) {\n      logging.Logger.debug('Success register push token with backend')\n      return\n    }\n    if (isRetry) {\n      logging.Logger.error('Unable to register expired subscription', subscription)\n    } else {\n      success = await this.refreshContactToken(meClientSvc)\n      if (success) {\n        logging.Logger.debug('Successful refreshed the contact token')\n        await this.registerNewSubscription(subscription, true)\n      } else {\n        logging.Logger.error('Unable to register expired subscription', subscription)\n      }\n    }\n  }\n\n  private async getApplicationServerKey (): Promise<string | undefined> {\n    try {\n      const result = await this.webPushDb.getApplicationServerPublicKey()\n      if (!result) {\n        logging.Logger.error('application server key not set')\n      }\n      return result\n    } catch (err) {\n      logging.Logger.error('application server error', err)\n      return undefined\n    }\n  }\n\n  private async showNotification (\n    message: string,\n    payload: any,\n    notificationTitle: string,\n    notificationIcon: string | undefined,\n    notificationImage: string | undefined,\n    notificationActions: NotificationAction[] | undefined\n  ) {\n    const notificationOptions = {\n      body: message,\n      data: payload,\n      icon: notificationIcon,\n      image: notificationImage,\n      actions: notificationActions,\n      vibrate: [400, 100, 400]\n    }\n    return self.registration.showNotification(notificationTitle, notificationOptions)\n  }\n\n  /*\n   * Get an option for notification.\n   * If the given option is in the customData (sent in the push) this value will be used.\n   * Otherwise it tries to read a default value from browser's indexDb (saved on serviceworker registration).\n   * If value is not present in indexDb it use the defaultValue parameter.\n   */\n  private async getNotificationOption<T = string> (\n    notificationData: NotificationData<T>,\n    notificationDataPropertyName: string,\n    dbFallbackFn: DbFallbackFn<T>\n  ): Promise<T | undefined> {\n    // eslint-disable-next-line\n    if (notificationData && notificationData[notificationDataPropertyName]) {\n      return Promise.resolve(notificationData[notificationDataPropertyName])\n    }\n    return dbFallbackFn()\n  }\n\n  private async handleInstall (): Promise<void> {\n    try {\n      await this.setupLogging()\n      logging.Logger.debug('Install handler')\n      logging.Logger.debug('Storing service worker version', __VERSION__)\n      await this.webPushDb.setServiceWorkerVersion(__VERSION__)\n      logging.Logger.debug('Skipping waiting')\n      await self.skipWaiting()\n      logging.Logger.debug('Install done')\n    } catch (err) {\n      // this log shall be written if we could not access the webPushDb at all\n      logging.Logger.error(err, 'Install error!')\n    }\n  }\n\n  private async setupLogging (): Promise<void> {\n    const loggingEnabled = await this.webPushDb.getLoggingEnabled()\n    logging.enableLogger(loggingEnabled, logging.SwContext)\n  }\n\n  /**\n   * Calls Emarsys open API endpoint to register the user has opened the notification.\n   */\n  private async reportOpen (notificationData: any): Promise<void> {\n    const des = await this.getDeviceEventService()\n    if (!des) {\n      logging.Logger.error('Cannot report open! DES not initialized!', notificationData)\n      return\n    }\n    try {\n      logging.Logger.debug('Reporting open to DES', notificationData)\n      const sid: string | undefined = notificationData?.messageData?.sid\n      const treatments: WebPushTreatments | undefined = notificationData?.messageData?.treatments\n      let attributes: MEEventAttributes | undefined = sid ? { sid } : undefined\n      attributes = attributes ? treatments ? { ...attributes, treatments: JSON.stringify(treatments) } : attributes : undefined\n      const openData: MEEvent = {\n        type: 'internal', name: 'webpush:click', timestamp: new Date().toISOString(), attributes\n      }\n      const eventsData: MEEventsRequestData = { dnd: true, events: [openData], clicks: [], viewedMessages: [] }\n      const result = await des.postEvents(eventsData)\n      if (!result.success && result.statusCode === 401) {\n        await this.retrySendAfterContactTokenRefresh(des, eventsData)\n      }\n    } catch (err) {\n      logging.Logger.error('Fatal error while reporting open!', err.message, err)\n    }\n  }\n\n  private async retrySendAfterContactTokenRefresh (\n    des: MEDeviceEventService,\n    eventsData: MEEventsRequestData\n  ): Promise<PostEventsResult> {\n    const meClientSvc = await this.getMeClientService()\n    if (!meClientSvc) {\n      logging.Logger.error('Unable to get the ME client service!')\n      return FailureResult\n    }\n    const success = await this.refreshContactToken(meClientSvc)\n    if (!success) {\n      return FailureResult\n    }\n    return des.postEvents(eventsData)\n  }\n\n  private async refreshContactToken (meClientSvc: MEClientService): Promise<boolean> {\n    try {\n      const success = await meClientSvc.generateAccessToken()\n      if (!success) {\n        logging.Logger.error('refresh of access token failed')\n      }\n      return success\n    } catch (err) {\n      logging.Logger.error('unable to refresh contact token', err)\n      return false\n    }\n  }\n\n  private async getDeviceEventService (): Promise<MEDeviceEventService | undefined> {\n    try {\n      if (!this.meDeviceEventService) {\n        const baseUrl = await this.webPushDb.getMeDeviceEventServiceApiBaseUrl()\n        this.meDeviceEventService = MEDeviceEventService.create(baseUrl, MEV3ApiRequest.create(), this.webPushDb)\n      }\n      return this.meDeviceEventService\n    } catch (err) {\n      logging.Logger.error('Error initializing device event service!', err.message, err)\n    }\n  }\n\n  private async getMeClientService (): Promise<MEClientService | undefined> {\n    try {\n      if (!this.meClientService) {\n        const baseUrl = await this.webPushDb.getMeClientServiceApiBaseUrl()\n        this.meClientService = MEClientService.create(baseUrl, MEV3ApiRequest.create(), this.webPushDb)\n      }\n      return this.meClientService\n    } catch (err) {\n      logging.Logger.error('Error initializing client service!', err.message, err)\n    }\n  }\n\n  private createActionsFromActionButtons (actionButtons: ActionButton[]): NotificationAction[] {\n    return actionButtons.map(actionButton => ({\n      action: actionButton.id,\n      title: actionButton.title\n    }))\n  }\n\n  static create (webPushDb: MEWebPushDb): EmarsysServiceWorker {\n    return new EmarsysServiceWorker(webPushDb)\n  }\n}\n"],"sourceRoot":""}